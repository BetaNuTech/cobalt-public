<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

<% content_for :header do %>
  <div id="application_header_logo">
      <%= link_to root_path, data: { turbolinks: false } do %>
          <%= show_svg('cobalt_report_white.svg') %>
      <% end %>
  </div>
  <div id="application_header_second_image"><%= image_tag "trm_blue_shift_logo.png" %></div>
<% end %>

<input id='current_metric_id' type='hidden' value='<%= @current_metric.id %>'>
<input id='property_id' type='hidden' value='<%= @property.id %>'>
<input id='created_on_date' type='hidden' value='<%= @todays_date %>'>

<div id="trm_blue_shift_form">
  <div id="view_past_trm_blue_shifts">
    <%= link_to "View past TRM BlueShifts", property_trm_blue_shifts_path(property_id: @property.id) %>
  </div>
  <br />
  <div id="archive_container">
    <% if @trm_blue_shift.archived? %>
      <span style="color: <%= @trm_blue_shift.archived_status == 'success' ? 'blue' : 'red' %>">
        
        <% if @trm_blue_shift.initial_archived_status != @trm_blue_shift.archived_status && @trm_blue_shift.archive_edit_user && @trm_blue_shift.archive_edit_date %>
          Archived as a <%= @trm_blue_shift.initial_archived_status %>
          (Overridden as a <%= @trm_blue_shift.archived_status %> by <%= @trm_blue_shift.archive_edit_user.first_name %> <%= @trm_blue_shift.archive_edit_user.last_name %> on <%= @trm_blue_shift.archive_edit_date %>)
        <% else %> 
          Archived as a <%= @trm_blue_shift.archived_status %>
        <% end %>
        <br />
        <% if can? :edit_archived_status, @trm_blue_shift %> 
          <%= form_for [@property, @trm_blue_shift], method: @trm_blue_shift.persisted? ? 'patch' : 'post',
            url: { action: "archive" } do |f| %>
            <button id="edit_archive_action">Change</button>
            <span id="edit_archive_details_container">
              <br>
              <span>Change Archived TRM BlueShift to</span>
              <%= f.radio_button :archived_status, "success", value: "success", class: 'editable'  %>
              <%= f.label :archived_status_success, "Success" %>
              <%= f.radio_button :archived_status, "failure", value: "failure", class: 'editable'  %>
              <%= f.label :archived_status_failure, "Failure" %>
              
              <%= f.submit "Submit", class: "editable", 
                data: { confirm: "Are you sure you wish to update this archive?" } %>
              <button id="cancel_edit_archive">Cancel</button>
            </span>
          <% end %> 
        <% end %> 
      </span>
    <% elsif can? :archive, @trm_blue_shift %>
      <%= form_for [@property, @trm_blue_shift], method: @trm_blue_shift.persisted? ? 'patch' : 'post',
        url: { action: "archive" } do |f| %>
        <button id="archive_action">Archive</button>
        <span id="archive_details_container">
          <span>Archive TRM BlueShift as a</span>
          <%= f.radio_button :archived_status, "success", value: "success", class: 'editable'  %>
          <%= f.label :archived_status_success, "Success" %>
          <%= f.radio_button :archived_status, "failure", value: "failure", class: 'editable'  %>
          <%= f.label :archived_status_failure, "Failure" %>
          
          <%= f.submit "Submit for Archiving", class: "editable", 
            data: { confirm: "Are you sure you wish to archive this TRM BlueShift?" } %>
          <button id="cancel_archiving">Cancel</button>
        </span>
      <% end %> 
    <% end %>
    <% if can? :delete, @trm_blue_shift %>
      <%= button_to "Delete", 
        property_trm_blue_shift_path(@trm_blue_shift.property.id, @trm_blue_shift.id), 
        method: :delete, 
        data: { confirm: "Are you sure you wish to delete this TRM BlueShift? All data and comments associated with this TRM BlueShift will be deleted as well." },
        class: "editable" %>
    <% end %>
  </div>
  
  <% if @trm_blue_shift.errors.any? %>
    <div id="error_explanation">
      <h2>
        <%= pluralize(@trm_blue_shift.errors.count, "error") %> prohibited
        the TRM BlueShift from being saved:
      </h2>
      <ul>
        <% @trm_blue_shift.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <br>
  <%= form_for [@property, @trm_blue_shift], method: @trm_blue_shift.persisted? ? 'patch' : 'post' do |f| %>
    <div>
      <label>
        <% if @property.type == 'Team' %>
          TEAM:
        <% else %>
          PROPERTY:
        <% end %>
      </label>
      <%= @property.code %>
    </div>
    <% if @property.type != 'Team' %>
      <div>
      <label>
        LOCATION:
      </label>
      <%= @property.city %>, <%= @property.state %>
      </div>
    <% end %>
    <div>
      <label>
        NAME/TITLE:
      </label>
      <%= @trm_blue_shift.user.name %>
    </div>
    <div>
      <label>
        TRM BLUESHIFT CREATION DATE:
      </label>
      <span id="created_on_readonly_text">
        <%= formatted_date(@todays_date) %>
      </span>
      <%= f.hidden_field :created_on, value: @todays_date.to_s %>
    </div>
    <% if @due_date %>
      <div>
        <label>
          TRM BLUESHIFT DUE DATE:
        </label>
        <span>
          <%= formatted_date(@due_date) %>
        </span>
      </div>
    <% end %>

    <br/>
    <div><u>TRM Blueshift Creation Date Metrics:</u></div>
    <div class="trm_blue_shift_metrics">
      <span class="level-3"style="text-align: center;">
        <%= @triggers_causing_trm_blue_shift.html_safe %>
      </span>
    </div>
    <br/>
    <% if @latest_metric %>
    <div><u><% if @is_archived_current %>Archived<% else %>Current<% end %> Metrics:</u></div>
    <div class="trm_blue_shift_metrics">
      <span class="level-3"style="text-align: center;">
        <%= @latest_triggers_trm_blue_shift.html_safe %>
      </span>
    </div>
    <% end %>
    <br>

    <p>
      <strong>
        MY PAST METRIC(S) IS/ARE <span class="red">IN THE RED</span> BECAUSE I HAVE:
      </strong>
    </p>
    <div class="trm_blue_shift_section">
      <strong>
        A MANAGER PROBLEM?
      </strong>
      <div class="trm_blue_shift_selection">
        <%= f.radio_button :manager_problem, false, value: false, checked: true,
          class: can?(:add_trm_blue_shift_problem, @trm_blue_shift, :manager_problem) ? 'editable' : '' %> 
        <%= f.label :manager_problem_false do %>
          <strong>NO</strong> - 
          Manager understands and addresses Pricing Problem, People Problem and Product Problem.
        <% end %>
      </div>
      <div class="trm_blue_shift_selection">
        <%= f.radio_button :manager_problem, true, value: true,
          class: can?(:add_trm_blue_shift_problem, @trm_blue_shift, :manager_problem) ? 'editable' : ''  %>
        <%= f.label :manager_problem_true do %>
          <strong>YES</strong> - 
          I am listing below a specific manager problem(s), and what I am doing to fix:
        <% end %>
        <div class="trm_blue_shift_input">
          <% if can?(:add_trm_blue_shift_problem, @trm_blue_shift, :manager_problem) %>
            Manager problem detail:</br>
            <%= f.text_area :manager_problem_details, cols: 90, rows: 10, class: 'editable' %></br>
            Plan to fix:</br>
            <%= f.text_area :manager_problem_fix, cols: 90, rows: 10, class: 'editable' %>
          <% else %>
            Manager problem detail:</br>
            <div class="text_area_static_text"><%= simple_format(@trm_blue_shift.manager_problem_details || '') %></div></br>
            Plan to fix:</br>
            <div class="text_area_static_text"><%= simple_format(@trm_blue_shift.manager_problem_fix || '') %></div>
          <% end %> 

          Results:</br>
          <% if @unlock_manager_problem_results and can?(:edit_results, @trm_blue_shift) %>
            <%= f.text_area :manager_problem_results, cols: 90, rows: 10, class: 'editable' %>
          <% elsif @trm_blue_shift.archived %>
            <div class="text_area_static_text"><%= simple_format(@trm_blue_shift.manager_problem_results || '') %></div>
          <% else %>
            <textarea cols="90" placeholder="<locked until fix by date>" disabled></textarea>
          <% end %>

          <br /><br />        
          I WILL FIX MY MANAGER PROBLEM BY 
          <%= render "editable_date", f: f, 
            problem: :manager_problem,
            attribute: "manager_problem_fix_by",
            value: @trm_blue_shift.manager_problem_fix_by %>
        </div>
        <% if @trm_blue_shift.manager_problem_comment_thread.present? and @trm_blue_shift.manager_problem_comment_thread.persisted? %>    
          <div>
            <%= hidden_field_tag 'manager_problem_comment_thread_id', 
              @trm_blue_shift.manager_problem_comment_thread.id, class: "comment_thread_id" %>
            <%= commontator_thread(@trm_blue_shift.manager_problem_comment_thread) %>
          </div>
        <% end %>
      </div>
    </div>
    
    <div class="trm_blue_shift_section">
      <strong>
        A MARKET PROBLEM?
      </strong>
      <div class="trm_blue_shift_selection">
        <%= f.radio_button :market_problem, false, value: false, checked: true,
          class: can?(:add_trm_blue_shift_problem, @trm_blue_shift, :market_problem) ? 'editable' : '' %> 
        <%= f.label :market_problem_false do %>
          <strong>NO</strong>
        <% end %>
      </div>
      <div class="trm_blue_shift_selection">
        <%= f.radio_button :market_problem, true, value: true,
          class: can?(:add_trm_blue_shift_problem, @trm_blue_shift, :market_problem) ? 'editable' : ''   %>
        <%= f.label :market_problem_true do %>
          <strong>YES</strong>
        <% end %>
        <div class="trm_blue_shift_input">
          <% if can?(:add_trm_blue_shift_problem, @trm_blue_shift, :market_problem) %>
            Market problem detail:</br>
            <%= f.text_area :market_problem_details, cols: 90, rows: 10, class: 'editable' %></br>
          <% else %>
            Market problem detail:</br>
            <div class="text_area_static_text"><%= simple_format(@trm_blue_shift.market_problem_details || '') %></div></br>
          <% end %> 
        </div>
        <% if @trm_blue_shift.market_problem_comment_thread.present? and @trm_blue_shift.market_problem_comment_thread.persisted? %>
          <div>
            <%= hidden_field_tag 'market_problem_comment_thread_id', 
              @trm_blue_shift.market_problem_comment_thread.id, class: "comment_thread_id" %>
            <%= commontator_thread(@trm_blue_shift.market_problem_comment_thread) %>
          </div>
        <% end %>        
      </div>  
    </div>
    
    <div class="trm_blue_shift_section">
      <strong>
        A MARKETING PROBLEM?
      </strong>
      <div class="trm_blue_shift_selection">
        <%= f.radio_button :marketing_problem, false, value: false, checked: true,
          class: can?(:add_trm_blue_shift_problem, @trm_blue_shift, :marketing_problem) ? 'editable' : '' %> 
        <%= f.label :marketing_problem_false do %>
          <strong>NO</strong>
        <% end %>
      </div>
      <div class="trm_blue_shift_selection">
        <%= f.radio_button :marketing_problem, true, value: true,
          class: can?(:add_trm_blue_shift_problem, @trm_blue_shift, :marketing_problem) ? 'editable' : ''   %>
        <%= f.label :marketing_problem_true do %>
          <strong>YES</strong>
          <br />
        <% end %>
        <div class="trm_blue_shift_input">
          <div>
            <span class="level-0" style="text-align: left;">
              Num of leads needed: <strong><%= @num_of_leads_needed %></strong>, BlueSky leads: <strong><%= @bluesky_leads %></strong>
            </span>
            <% if @latest_num_of_leads_needed.present? && @latest_bluesky_leads.present? %>
            <span class="level-0" style="text-align: left;">
              Current num of leads needed: <strong><%= @num_of_leads_needed %></strong>, Current BlueSky leads: <strong><%= @bluesky_leads %></strong>
            </span>
            <% end %>
          </div>
          <br />
          <% if can?(:add_trm_blue_shift_problem, @trm_blue_shift, :marketing_problem) %>
            Marketing problem detail:</br>
            <%= f.text_area :marketing_problem_details, cols: 90, rows: 10, class: 'editable' %></br>
            Plan to fix:</br>
            <%= f.text_area :marketing_problem_fix, cols: 90, rows: 10, class: 'editable' %>
          <% else %>
            Marketing problem detail:</br>
            <div class="text_area_static_text"><%= simple_format(@trm_blue_shift.marketing_problem_details || '') %></div></br>
            Plan to fix:</br>
            <div class="text_area_static_text"><%= simple_format(@trm_blue_shift.marketing_problem_fix || '') %></div>
          <% end %> 
          <br /><br />        
          I WILL FIX MY MARKETING PROBLEM BY 
          <%= render "editable_date", f: f, 
            problem: :marketing_problem,
            attribute: "marketing_problem_fix_by",
            value: @trm_blue_shift.marketing_problem_fix_by %>
        </div>
        <% if @trm_blue_shift.marketing_problem_comment_thread.present? and @trm_blue_shift.marketing_problem_comment_thread.persisted? %>
          <div>
            <%= hidden_field_tag 'marketing_problem_comment_thread_id', 
              @trm_blue_shift.marketing_problem_comment_thread.id, class: "comment_thread_id" %>
            <%= commontator_thread(@trm_blue_shift.marketing_problem_comment_thread) %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="trm_blue_shift_section">
      <strong>
        A CAPITAL PROBLEM?
      </strong>
      <div class="trm_blue_shift_selection">
        <%= f.radio_button :capital_problem, false, value: false, checked: true,
          class: can?(:add_trm_blue_shift_problem, @trm_blue_shift, :capital_problem) ? 'editable' : '' %> 
        <%= f.label :capital_problem_false do %>
          <strong>NO</strong>
        <% end %>
      </div>
      <div class="trm_blue_shift_selection">
        <%= f.radio_button :capital_problem, true, value: true,
          class: can?(:add_trm_blue_shift_problem, @trm_blue_shift, :capital_problem) ? 'editable' : ''   %>
        <%= f.label :capital_problem_true do %>
          <strong>YES</strong>
          <br />
        <% end %>
        <div class="trm_blue_shift_input">
          <div id="property_latest_inspection_<%= @trm_blue_shift.property.id %>">
            <%= render partial: 'properties/latest_inspection', locals: {property: @trm_blue_shift.property, created_on: @trm_blue_shift.created_on} %>
          </div>
          <br />
          <% if can?(:add_trm_blue_shift_problem, @trm_blue_shift, :capital_problem) %>
            Capital problem detail:</br>
            <%= f.text_area :capital_problem_details, cols: 90, rows: 10, class: 'editable' %></br>
          <% else %>
            Capital problem detail:</br>
            <div class="text_area_static_text"><%= simple_format(@trm_blue_shift.capital_problem_details || '') %></div></br>
          <% end %> 
        </div>
        <% if @trm_blue_shift.capital_problem_comment_thread.present? and @trm_blue_shift.capital_problem_comment_thread.persisted? %>
          <div>
            <%= hidden_field_tag 'capital_problem_comment_thread_id', 
              @trm_blue_shift.capital_problem_comment_thread.id, class: "comment_thread_id" %>
            <%= commontator_thread(@trm_blue_shift.capital_problem_comment_thread) %>
          </div>
        <% end %>
      </div>
    </div>
    <br><br>
    <div class="trm_blue_shift_section">
      <%= f.check_box :vp_reviewed, class: can?(:edit_vp_reviewed, @trm_blue_shift) ? 'editable' : ''%>
      <strong>
        VP Reviewed
      </strong>
    </div>

    <br />
    <% if !@form_disabled or can?(:add_trm_blue_shift_problem, @trm_blue_shift, :manager_problem) or
      can?(:add_trm_blue_shift_problem, @trm_blue_shift, :market_problem) or
      can?(:add_trm_blue_shift_problem, @trm_blue_shift, :marketing_problem) or
      can?(:add_trm_blue_shift_problem, @trm_blue_shift, :capital_problem) or
      (@unlock_manager_problem_results and can?(:edit_results, @trm_blue_shift)) or
      can?(:edit, @trm_blue_shift)%>
      <%= f.submit class: "editable" %>
    <% end %>
    
  <% end %>

</div>

<br />
<br />
